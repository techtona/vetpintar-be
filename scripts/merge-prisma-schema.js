#!/usr/bin/env node

/**
 * Prisma Multi-Schema Merger
 *
 * Merges multiple .prisma files from prisma/schemas/ into a single schema.prisma
 * This allows better organization of large schemas into logical domain files.
 *
 * Usage: npm run prisma:merge
 */

const fs = require('fs');
const path = require('path');

const SCHEMAS_DIR = path.join(__dirname, '../prisma/schemas');
const OUTPUT_FILE = path.join(__dirname, '../prisma/schema.prisma');

// Order matters: _base.prisma must be first (contains generator, datasource, enums)
const SCHEMA_FILES_ORDER = [
  '_base.prisma',     // Configuration & Enums
  'auth.prisma',      // User & ClinicAccess
  'clinic.prisma',    // Clinic
  'patient.prisma',   // Patient
  'medical.prisma',   // MedicalRecord & Hospitalization
  'inventory.prisma', // Product
  'billing.prisma',   // Invoice, InvoiceItem, Payment
  'appointment.prisma' // Appointment
];

function mergeSchemas() {
  console.log('üîÑ Merging Prisma schemas...\n');

  // Check if schemas directory exists
  if (!fs.existsSync(SCHEMAS_DIR)) {
    console.error(`‚ùå Error: ${SCHEMAS_DIR} does not exist`);
    process.exit(1);
  }

  let mergedContent = '';
  mergedContent += '// ============================================\n';
  mergedContent += '// AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY\n';
  mergedContent += '// ============================================\n';
  mergedContent += '// This file is auto-generated by merging files from /prisma/schemas/\n';
  mergedContent += '// To modify the schema, edit files in /prisma/schemas/ and run:\n';
  mergedContent += '// npm run prisma:merge\n';
  mergedContent += '// ============================================\n\n';

  // Read and merge schema files in order
  for (const filename of SCHEMA_FILES_ORDER) {
    const filePath = path.join(SCHEMAS_DIR, filename);

    if (!fs.existsSync(filePath)) {
      console.warn(`‚ö†Ô∏è  Warning: ${filename} not found, skipping...`);
      continue;
    }

    console.log(`  ‚úì Reading ${filename}`);

    let content = fs.readFileSync(filePath, 'utf-8');

    // For non-base files, remove generator/datasource if accidentally included
    if (filename !== '_base.prisma') {
      content = content.replace(/generator\s+\w+\s*{[^}]*}/g, '');
      content = content.replace(/datasource\s+\w+\s*{[^}]*}/g, '');
    }

    // Add content with spacing
    mergedContent += content.trim() + '\n\n';
  }

  // Check for additional schema files not in order list
  const allFiles = fs.readdirSync(SCHEMAS_DIR).filter(f => f.endsWith('.prisma'));
  const extraFiles = allFiles.filter(f => !SCHEMA_FILES_ORDER.includes(f));

  if (extraFiles.length > 0) {
    console.log('\nüìù Found additional schema files:');
    for (const filename of extraFiles) {
      console.log(`  ‚ÑπÔ∏è  ${filename} (not in SCHEMA_FILES_ORDER)`);
      const filePath = path.join(SCHEMAS_DIR, filename);
      let content = fs.readFileSync(filePath, 'utf-8');

      // Remove generator/datasource
      content = content.replace(/generator\s+\w+\s*{[^}]*}/g, '');
      content = content.replace(/datasource\s+\w+\s*{[^}]*}/g, '');

      mergedContent += content.trim() + '\n\n';
    }
  }

  // Write merged schema
  fs.writeFileSync(OUTPUT_FILE, mergedContent.trim() + '\n');

  console.log('\n‚úÖ Successfully merged schemas into schema.prisma');
  console.log(`üìÑ Output: ${OUTPUT_FILE}`);
  console.log(`üìä Total files merged: ${SCHEMA_FILES_ORDER.length + extraFiles.length}`);

  // Show stats
  const lines = mergedContent.split('\n').length;
  const models = (mergedContent.match(/^model\s+\w+/gm) || []).length;
  const enums = (mergedContent.match(/^enum\s+\w+/gm) || []).length;

  console.log(`\nüìà Schema stats:`);
  console.log(`  - ${lines} lines`);
  console.log(`  - ${models} models`);
  console.log(`  - ${enums} enums`);

  console.log('\nüí° Next steps:');
  console.log('  1. Run: npx prisma format');
  console.log('  2. Run: npx prisma generate');
  console.log('  3. Run: npx prisma migrate dev (if needed)\n');
}

// Run the merger
try {
  mergeSchemas();
} catch (error) {
  console.error('‚ùå Error merging schemas:', error.message);
  process.exit(1);
}
